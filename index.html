<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ramallah WebGIS - Phase 1+2</title>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Turf.js for Phase 2 features -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
body, html { margin:0; padding:0; height:100%; }
#map { height:100vh; }

#legend-box { position:absolute; bottom:45px; left:10px; background:white; padding:10px 14px; border-radius:10px; width:220px; box-shadow:0 0 10px rgba(0,0,0,0.3); font-family:Arial; z-index:9998;}
#legend-title{ font-weight:bold; text-align:center; font-size:16px; cursor:pointer; user-select:none;}
#legend-content{ display:none; margin-top:8px; font-size:14px;}
.legend-item{ display:flex; align-items:center; margin-bottom:5px;}
.emoji{ font-size:20px; width:25px; margin-right:6px;}
.symbol-line{ width:30px; height:4px; margin-right:6px;}
.symbol-poly{ width:22px; height:12px; border:1px solid #000; margin-right:6px;}

#opacity-box{ position:absolute; right:10px; bottom:45px; background:white; padding:12px; border-radius:10px; width:220px; box-shadow:0 0 10px rgba(0,0,0,0.3); font-family:Arial; z-index:9999;}
#opacity-title{ font-weight:bold; text-align:center; font-size:15px; margin-bottom:8px;}
select, input[type=range]{ width:100%; margin-top:6px; }
.leaflet-control-scale{ left:50% !important; transform:translateX(-50%); bottom:5px !important; }
</style>
</head>
<body>
<div id="map"></div>

<!-- OPACITY BOX -->
<div id="opacity-box">
    <div id="opacity-title">Layer Opacity</div>
    <select id="opacity-select"><option value="" disabled selected>Select Layer</option></select>
    <input id="opacity-slider" type="range" min="0" max="1" step="0.1" value="1">
</div>

<!-- LEGEND -->
<div id="legend-box">
    <div id="legend-title">Legend ‚ñº</div>
    <div id="legend-content">
        <div class="legend-item"><span class="emoji">üè´</span> Schools</div>
        <div class="legend-item"><span class="emoji">üíß</span> Wells</div>
        <div class="legend-item"><span class="emoji">‚õèÔ∏è</span> Quarries</div>
        <hr>
        <div class="legend-item"><span class="symbol-line" style="background:black"></span> Roads</div>
        <div class="legend-item"><span class="symbol-line" style="background:#0077ff"></span> Streams</div>
        <div class="legend-item"><span class="symbol-line" style="background:#555"></span> Annexation Wall</div>
        <hr>
        <div class="legend-item"><span class="symbol-poly" style="background:#8fd19e"></span> Agricultural Land</div>
        <div class="legend-item"><span class="symbol-poly" style="background:#ffb347"></span> Closed Areas</div>
        <div class="legend-item"><span class="symbol-poly" style="background:#c49a6c"></span> Built-up Areas</div>
        <div class="legend-item"><span class="symbol-poly" style="background:#af7ac5"></span> Master Plans</div>
        <div class="legend-item"><span class="symbol-poly" style="background:#ff6666"></span> Settlements</div>
        <div class="legend-item"><span class="symbol-poly" style="background:#87ceeb"></span> Temperature Zones</div>
        <div class="legend-item"><span class="symbol-poly" style="background:none"></span> Ramallah Boundary</div>
    </div>
</div>

<script>
// ====================
// INITIALIZE MAP
// ====================
var map = L.map("map").setView([31.903, 35.203], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
L.control.scale({imperial:false}).addTo(map);

// ====================
// LAYERS OBJECT
// ====================
var layers = { points: {}, lines: {}, polys: {} };
var control = L.control.layers({}, {}, {collapsed:false}).addTo(map);

// ====================
// POINT ICONS
// ====================
function getPointIcon(type){
    return L.divIcon({ html: type==="Schools"?"üè´":type==="Wells"?"üíß":type==="Quarries"?"‚õèÔ∏è":"‚Ä¢",
        className:"", iconSize:[25,25], iconAnchor:[12,12] });
}

// ====================
// LOAD LAYER FUNCTION
// ====================
function loadLayer(file,name,group,styleObj){
    $.getJSON(file,function(data){
        var layer;
        if(group==="points") layer = L.geoJson(data, { pointToLayer:(f,latlng)=>L.marker(latlng,{icon:getPointIcon(name)})}).addTo(map);
        else layer = L.geoJson(data,{ style: styleObj }).addTo(map);

        layers[group][name] = layer;
        control.addOverlay(layer,name);
        document.getElementById("opacity-select").innerHTML += `<option value="${name}">${name}</option>`;
    });
}

// ====================
// LOAD ALL BASE LAYERS
// ====================
loadLayer("Schools.geojson","Schools","points");
loadLayer("Wells.geojson","Wells","points");
loadLayer("Quarries.geojson","Quarries","points");

loadLayer("Roads.geojson","Roads","lines",{color:"black",weight:2});
loadLayer("Streams.geojson","Streams","lines",{color:"#0077ff",weight:2});
loadLayer("Annexation_Wall.geojson","Annexation Wall","lines",{color:"#555",weight:3});

loadLayer("Agricultural_Land.geojson","Agricultural Land","polys",{color:"green",fillColor:"#8fd19e",fillOpacity:0.6});
loadLayer("Areas_totaly_closed_by_the_wall.geojson","Closed Areas","polys",{color:"orange",fillColor:"#ffb347",fillOpacity:0.6});
loadLayer("Built_up.geojson","Built-up Areas","polys",{color:"brown",fillColor:"#c49a6c",fillOpacity:0.6});
loadLayer("Approved_Urban_Master_Plans_super_simplified.geojson","Master Plans","polys",{color:"purple",fillColor:"#af7ac5",fillOpacity:0.6});
loadLayer("Settlements.geojson","Settlements","polys",{color:"red",fillColor:"#ff6666",fillOpacity:0.6});
loadLayer("Temperature.geojson","Temperature Zones","polys",{color:"blue",fillColor:"#87ceeb",fillOpacity:0.6});
loadLayer("Ramallah.geojson","Ramallah Boundary","polys",{color:"black",fillOpacity:0});

// ====================
// LEGEND TOGGLE
// ====================
document.getElementById("legend-title").onclick = function(){
    let c = document.getElementById("legend-content");
    c.style.display = c.style.display==="none"?"block":"none";
    this.innerHTML = c.style.display==="none"?"Legend ‚ñº":"Legend ‚ñ≤";
};

// ====================
// OPACITY CONTROL
// ====================
document.getElementById("opacity-slider").oninput = function(){
    let selected = document.getElementById("opacity-select").value;
    for(let group in layers){
        if(layers[group][selected]){
            layers[group][selected].setStyle({ opacity:this.value, fillOpacity:this.value });
        }
    }
};

// ====================
// PHASE 2 FEATURES (7-12)
// ====================

// FEATURE 7: Isolated Land Detector
function detectIsolatedLand(wallLayer, landLayer){
    wallLayer.eachLayer(function(wall){
        landLayer.eachLayer(function(land){
            var diff = turf.difference(land.toGeoJSON(), wall.toGeoJSON());
            if(diff) L.geoJSON(diff,{style:{color:"#6c5ce7",fillOpacity:0.5}}).addTo(map);
        });
    });
}

// FEATURE 8: Road Disruption Analyzer
function analyzeRoadDisruption(wallLayer, roadLayer){
    roadLayer.eachLayer(function(road){
        wallLayer.eachLayer(function(wall){
            var intersect = turf.lineIntersect(road.toGeoJSON(), wall.toGeoJSON());
            if(intersect.features.length>0) L.geoJSON(road.toGeoJSON(),{style:{color:"#00cec9",weight:4,dashArray:"5,5"}}).addTo(map);
        });
    });
}

// FEATURE 9: Land Fragmentation Analysis
function landFragmentation(landLayer){
    landLayer.eachLayer(function(poly){
        var coords = turf.explode(poly.toGeoJSON());
        if(coords.features.length>0) L.circleMarker([coords.features[0].geometry.coordinates[1],coords.features[0].geometry.coordinates[0]],{radius:2,color:"red"}).addTo(map);
    });
}

// FEATURE 10: Settlement Threat Index
function settlementThreat(settlementLayer, landLayer){
    settlementLayer.eachLayer(function(settlement){
        landLayer.eachLayer(function(land){
            var buffer = turf.buffer(settlement.toGeoJSON(),500,{units:"meters"});
            var intersection = turf.intersect(buffer, land.toGeoJSON());
            if(intersection) L.geoJSON(intersection,{style:{color:"#55efc4",fillOpacity:0.6}}).addTo(map);
        });
    });
}

// FEATURE 11: Service Inequality Mapping
function serviceInequality(services, landLayer){
    services.eachLayer(function(service){
        landLayer.eachLayer(function(land){
            var buffer = turf.buffer(service.toGeoJSON(),1000,{units:"meters"});
            var diff = turf.difference(land.toGeoJSON(), buffer);
            if(diff) L.geoJSON(diff,{style:{color:"#fab1a0",fillOpacity:0.5}}).addTo(map);
        });
    });
}

// FEATURE 12: Land Suitability Analyzer
function landSuitability(agriLayer, tempLayer, builtLayer){
    agriLayer.eachLayer(function(agri){
        tempLayer.eachLayer(function(temp){
            builtLayer.eachLayer(function(built){
                var intersect = turf.intersect(agri.toGeoJSON(), temp.toGeoJSON());
                if(intersect){
                    var finalIntersect = turf.difference(intersect, built.toGeoJSON());
                    if(finalIntersect) L.geoJSON(finalIntersect,{style:{color:"#ffeaa7",fillOpacity:0.6}}).addTo(map);
                }
            });
        });
    });
}

// APPLY PHASE 2 FEATURES AFTER LAYERS LOADED
function applyPhase2Features(){
    if(
        layers.polys["Ramallah Boundary"] &&
        layers.polys["Agricultural Land"] &&
        layers.polys["Built-up Areas"] &&
        layers.polys["Temperature Zones"] &&
        layers.polys["Settlements"] &&
        layers.polys["Annexation Wall"] &&
        layers.lines["Roads"] &&
        layers.points["Schools"] &&
        layers.points["Wells"]
    ){
        detectIsolatedLand(layers.polys["Annexation Wall"], layers.polys["Agricultural Land"]);
        analyzeRoadDisruption(layers.polys["Annexation Wall"], layers.lines["Roads"]);
        landFragmentation(layers.polys["Agricultural Land"]);
        settlementThreat(layers.polys["Settlements"], layers.polys["Agricultural Land"]);
        landSuitability(layers.polys["Agricultural Land"], layers.polys["Temperature Zones"], layers.polys["Built-up Areas"]);
        serviceInequality(layers.points["Schools"], layers.polys["Built-up Areas"]);
        serviceInequality(layers.points["Wells"], layers.polys["Built-up Areas"]);
    } else {
        setTimeout(applyPhase2Features,1000);
    }
}
applyPhase2Features();
</script>
</body>
</html>
